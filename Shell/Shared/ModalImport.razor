@using OfficeOpenXml
@using Shell.Data
@using Shell.Model
@using Shell.Service
@inject IclsDefault my_clsDefault
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<div class="modal @ModalClass" id="modalimport" tabindex="-1" role="dialog" style="display:@ModalDisplay">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border:0;">
                <button type="button" class="close" @onclick="@ModalCancel"><span aria-hidden="true">&times;</span></button>
            </div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div id="divimport" style="display:@divimport_Display">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 rows">
                            <div class="input-group">
                                <label for="fuAttachFile" class="col-form-label">กรุณาเลือกไฟล์ข้อมูลร้านค้า</label>
                                <InputFile ID="fuAttachFile" class="form-control" OnChange="@LoadFileToVM" />
                            </div>
                            <div class="input-group text-danger">** ไฟล์ข้อมูลที่นำเข้าต้องไม่มี ( ‘ ) หากระบบตรวจพบจะดำเนินการลบอัตโนมัติ</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border:0;">
                    <div class="row">
                        <div class="col-md-3">&nbsp;</div>
                        <div class="col-md-3"><button type="button" ID="btnImport" @onclick=@divImport_OK class="btn btn-success btn-block login-button">ตกลง</button></div>
                        <div class="col-md-3"><button type="button" class="btn btn-default btn-block" @onclick="@ModalCancel">ยกเลิก</button></div>
                    </div>
                </div>
            </div>
            <div id="divok" style="display:@divok_Display">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 rows">
                            <div class="input-group text-center">
                                <label class="col-form-label">คุณยืนยันที่จะนำข้อมูลเข้าระบบใช่หรือไม่</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border:0;">
                    <div class="row">
                        <div class="col-md-3">&nbsp;</div>
                        <div class="col-md-3"><button type="button" ID="btnImport" @onclick=@divok_OK class="btn btn-success btn-block login-button">ตกลง</button></div>
                        <div class="col-md-3"><button type="button" class="btn btn-default btn-block" @onclick="@divok_Cancel">ยกเลิก</button></div>

                    </div>
                </div>
            </div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
        </div>
    </div>
</div>
@if (ShowBackdrop)
{
    <div class="modal-backdrop fade in"></div>
}

@code {
    [Parameter]
    public EventCallback<bool> OnClose { get; set; }

    public string ModalDisplay = "none;";
    public string ModalClass = "";
    public bool ShowBackdrop = false;

    public string divimport_Display = "block;";
    public string divok_Display = "none;";

    public string ViewState_Import;
    string AttatchFolder = "upload";
    string FileExtension = ".xlsx";
    string imp = "Master";

    public IBrowserFile browserFile;

    private Task ModalCancel()
    {
        this.Close();
        return OnClose.InvokeAsync(false);
    }
    private Task ModalOk()
    {
        return OnClose.InvokeAsync(true);
    }

    void LoadFileToVM(InputFileChangeEventArgs e)
    {
        browserFile = e.GetMultipleFiles(1).First();
    }

    public void Open()
    {
        ModalDisplay = "block;";
        ModalClass = "Show";
        ShowBackdrop = true;
        StateHasChanged();
    }

    public void Close()
    {
        ModalDisplay = "none";
        ModalClass = "";
        ShowBackdrop = false;
        StateHasChanged();
    }

    private async Task divImport_OK()
    {
        divimport_Display = "none";
        divok_Display = "block;";

        var impid = await GenIDFromStore();
        var usrid = await sessionStorage.GetItemAsync<string>("UserID");
        try
        {
            using (var db = new SHELLREGContext())
            {
                db.ImportControls.Add(new ImportControl()
                    {
                        ImportId = impid,
                        ImportType = imp,
                        ImportDateTime = Convert.ToDecimal(DateTime.Now.ToString("yyyyMMddHHmmss")),
                        UsrId = usrid,
                    });
                db.SaveChanges();
            }
            UploadFile(impid);
        }
        catch (Exception ex)
        {
        }

    }

    async Task<bool> UploadFile(string ImportID)
    {
        long maxFileSize = 1024 * 15 * 10;
        //var trustedFileNameForFileStorage = Path.GetRandomFileName() + ".xlsx";


        string fileExt = Path.GetExtension(browserFile.Name);

        string contentpath = my_clsDefault.ContentRootPath();

        var mappath = Path.Combine(contentpath, AttatchFolder);
        if (fileExt == FileExtension)
        {
            if (!Directory.Exists(mappath))
            {
                Directory.CreateDirectory(mappath);
            }
            var trustedFileNameForFileStorage = ImportID + fileExt;
            var filepath = Path.Combine(mappath,
                    trustedFileNameForFileStorage);
            await using FileStream fs = new(filepath, FileMode.Create);
            await browserFile.OpenReadStream(maxFileSize).CopyToAsync(fs);

            return true;
        }
        else
        {
            /*diverror.Visible = true;
            lblMsg = "กรุณาเลือกไฟล์ .xlsx";
            updateResultImport(ImportID, "0001", lblMsg.Text);
            return false;*/
            return false;
        }
    }
    
    public void ReadExcel(string filepath)
    {
        FileInfo existingfile = new FileInfo(filepath);
        ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
        using (ExcelPackage package = new ExcelPackage(existingfile))
        {
            ExcelWorksheet worksheet = package.Workbook.Worksheets.FirstOrDefault();
            var MasterImportList = ExceltoDatatable.ConvertTableToObjects<MasterExcelImportData>(worksheet.Tables.First());
            foreach (var eachImportData in MasterImportList)
            {
                
            }
        }
    }

    public async Task<string> GenIDFromStore()
    {
        var DateTwoDigits = DateTime.Now.ToString("yy");
        return await my_clsDefault.GenID(DateTwoDigits);
    }

    public void divok_OK()
    {

    }
    public void divok_Cancel()
    {
        divok_Display = "none";
        divimport_Display = "block;";
    }
}
