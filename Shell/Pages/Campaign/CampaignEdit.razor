@page "/campaignedit"

<div id="page-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 title-head">
                <h1><img src="Resource/img/config.png" alt="" />ข้อมูลแต้มสินค้า</h1>
            </div>
        </div>
        @if (diverror_Visible)
        {
            <div id="diverror" visible="false" class="alert alert-danger" role="alert">@lblMsg</div>
        }
        <div class="row">
            <div class="col-md-1">&nbsp;</div>
            <div class="col-md-10">
                <div class="panel panel-default">
                    <div class="panel-heading">กำหนดแต้มสินค้า</div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6 rows">
                                <div class="input-group input-daterange">
                                    <span class="input-group-addon edit-text">รหัสแคมเปญสินค้า</span>
                                    <input type="text" id="campaigncode" @bind="input_campaigncode" class="form-control" ReadOnly="true" />
                                    <span class="validate-text">*</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 rows">
                                <div class="input-group input-daterange">
                                    <span class="input-group-addon edit-text">ชื่อแคมเปญสินค้า</span>
                                    <input type="text" id="campaignname" @bind="input_campaignname" class="form-control" readonly="@campaignname_ReadOnly"/>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 rows">
                                <div class="datepicker input-group input-daterange">
                                    <span class="input-group-addon edit-text">วันที่เริ่มต้น <i class="fa fa-calendar ifrom" aria-hidden="true"></i></span>
                                    <input type="date" id="start_date" @bind="InputStartDate" class="form-control" autocomplete="off" readonly="@start_date_ReadOnly" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 rows">
                                <div class="datepicker input-group input-daterange">
                                    <span class="input-group-addon edit-text">วันที่สิ้นสุด <i class="fa fa-calendar ito" aria-hidden="true"></i></span>
                                    <input type="date" id="end_date" @bind="InputEndDate" class="form-control" autocomplete="off" readonly="@end_date_ReadOnly"/>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 rows">
                                <div class="input-group input-daterange">
                                    <span class="input-group-addon edit-text">สถานะ</span>
                                    <select id="status" class="form-control" @bind="statusSelected" disabled="@status_disable">
                                        <option Value="active">active</option>
                                        <option Value="inactive">inactive</option>
                                    </select>
                                    <span class="validate-text">*</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>&nbsp;</div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-page text-right form-inline">
                            @if (hplImport_Visible)
                            {
                                <a id="hplImport" class="btn btn-default" data-toggle="modal" data-target="#modalimport" ><i class="glyphicon glyphicon-save-file"></i> นำข้อมูลเข้า</a>
                            }
                        </div>
                    </div>
                </div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="no-more-tables">
                            <table class="table-bordered table-striped table-condensed tables">
                                <thead id="thContent">
                                    <tr>
                                        <th width="5%">ลำดับ</th>
                                        <th width="10%">รหัสสินค้า</th>
                                        <th width="10%">MaterialCode</th>
                                        <th width="40%">ชื่อสินค้า</th>
                                        <th width="5%">แต้ม</th>
                                        <th width="30%">ร้านค้าร่วมรายการ</th>
                                    </tr>
                                </thead>
                                <tbody id="tbContent">
                                    @{
                                        int i = 0;
                                    }
                                    @foreach (var each_data in searchDataPaged)
                                    {
                                        i++;
                                        <tr>
                                            <td align="center">@i</td>
                                            <td>@each_data.SalesTextCode</td>
                                            <td>@each_data.MaterialCode</td>
                                            <td>@each_data.ProductName</td>
                                            <td align="center">@each_data.Point</td>
                                            <td>@each_data.ACodeUse</td>
                                        </tr>
                                    }
                                    @if (IsEmpty)
                                    {
                                        <tr>
                                            <td align='center' colspan='6'>
                                                <b>ไม่มีข้อมูล</b>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div class="row">
                    <div class="col-xs-12 text-center">
                        <div class="form-group">
                            <a id="hplback" href="@hplback_NavigateUrl" class="btn btnred" style="width:100px;">กลับ</a>
                            &nbsp;&nbsp;&nbsp;
                            @if (btnCreate_Visible)
                            {
                                <button id="btnCreate" class="btn btnyellow" style="width:100px;" @onclick="btnCreate_Click" >สร้างแคมเปญ</button>
                            }
                            @if (btnSave_Visible)
                            {
                                <button id="btnSave" class="btn btnyellow" style="width:100px;" @onclick="btnSave_Click" >บันทึก</button>
                            }
                        </div>
                    </div>
                </div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
            </div>
            <div class="col-md-1">&nbsp;</div>
        </div>
        <div>&nbsp;</div>
    </div>
</div>

@using BlazorDateRangePicker
@inject IJSRuntime jsRuntime
@using Shell.Data
@using Shell.Model
@using Shell.Service
@inject ISecure secure

@code {
    //PARAM
    [Parameter]
    [SupplyParameterFromQuery]
    public string? keyword { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public string? field { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public string? start { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public string? end { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public string? status { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public string? act { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public string? id { get; set; }

    //from url param
    public string hplback_NavigateUrl;
    public string hdfact;

    //html
    public string lblMsg;
    public DateTimeOffset? InputStartDate { get; set; }
    public DateTimeOffset? InputEndDate { get; set; }
    //html visible disable
    public bool IsEmpty = false;
    public bool diverror_Visible = false;
    public bool campaignname_ReadOnly = false;
    public bool start_date_ReadOnly = false;
    public bool end_date_ReadOnly = false;
    public bool status_disable = false;
    public bool btnCreate_Visible = false;
    public bool btnSave_Visible = false;
    public bool hplImport_Visible = false;


    public string? input_campaigncode { get; set; }
    public string? input_campaignname { get; set; }

    public List<CampaignEditSearchData> searchData_iquery = new List<CampaignEditSearchData>();
    public List<CampaignEditSearchData> searchDataPaged = new List<CampaignEditSearchData>();

    public string statusSelected = "active";


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!(await secure.Page_Init()))
            {
                return;
            }
            await Authorize();

            int i = 0;
            string url = "";
            string paremeter = "?keyword=" + keyword
                                + "&field=" + field
                                + "&status=" + status;
            url = "campaignlist" + paremeter;
            hplback_NavigateUrl = url;
            //ViewState["url"] = url;
            hdfact = act;
            if (act == "view")
            {
                campaignname_ReadOnly = true;
                start_date_ReadOnly = true;
                end_date_ReadOnly = true;
                status_disable = true;
                btnCreate_Visible = false;
                btnSave_Visible = false;
                hplImport_Visible = false;
            }
            else if (act == "add")
            {
                btnSave_Visible = false;
                hplImport_Visible = false;
            }
            else if (act == "edit")
            {
                start_date_ReadOnly = true;
                end_date_ReadOnly = true;
                btnCreate_Visible = false;
            }
            GetData();
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    public async Task Authorize()
    {
        int chk_authorize1 = await secure.Check_Menu_Authorize("3");
        int chk_authorize2 = await secure.Check_Document_Authorize("6", "3");
        if (chk_authorize1 == 0 || chk_authorize2 == 0)
        {
            Console.Write("<br /><br /><center>ท่านไม่ได้รับสิทธิในการใช้งานส่วนนี้ <a href='Javascript:void(0);' @onclick='history.back();'>ย้อนกลับ</a></center>");
            //Response.End();
        }
        else
        {
            int Create_Per = await secure.Check_Document_Authorize("6", "1");
            if (Create_Per == 1)
            {
                btnCreate_Visible = true;
            }
            int Edit_Per = await secure.Check_Document_Authorize("6", "2");
            if (Create_Per == 1 || Edit_Per == 1)
            {
                btnSave_Visible = true;
            }
            if (Create_Per == 1 && Edit_Per == 1)
            {
                hplImport_Visible = true;
            }
        }
    }

    private void GetData()
    {
        using (var db = new SHELLREGContext())
        {
            var filter = db.Campaigns.Where(t => t.CampaignCode == id);
            if (filter.Any())
            {
                var founded = filter.First();
                input_campaigncode = founded.CampaignCode;
                input_campaignname = founded.CampaignName;
                InputStartDate = !string.IsNullOrWhiteSpace(founded.StartDate) ? DateTimeOffset.ParseExact(founded.StartDate, "dd/MM/yyyy", null) : null;
                InputEndDate = !string.IsNullOrWhiteSpace(founded.EndDate) ? DateTimeOffset.ParseExact(founded.EndDate, "dd/MM/yyyy", null) : null;
                statusSelected = founded.Status;

                var joined = (
                    from cp in db.CampaignProducts.Where(t => t.CampaignCode == id)
                    from p in db.Products.Where(t => t.MaterialCode == cp.MaterialCode)

                    select new CampaignEditSearchData()
                        {
                            SalesTextCode = p.SalesTextCode,
                            MaterialCode = p.MaterialCode,
                            ProductName = p.ProductName,
                            Point = "",//p.point
                            ACodeUse = cp.AcodeUse,
                        }

                ).ToList();
                searchDataPaged = joined;

            }
        }
    }
    void btnCreate_Click()
    {

    }
    void btnSave_Click()
    {

    }
}





<div class="modal fade" id="modalimport" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border:0;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div id="divimport"  >
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 rows">
                            <div class="input-group">
                                <label for="fuAttachFile" class="col-form-label">กรุณาเลือกไฟล์ข้อมูลแต้มสินค้า</label>
                                <asp:FileUpload id="fuAttachFile" class="form-control" />
                            </div>
                            <div class="input-group text-danger">** ไฟล์ข้อมูลที่นำเข้าต้องไม่มี ( ‘ ) หากระบบตรวจพบจะดำเนินการลบอัตโนมัติ</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border:0;">
                    <div class="row">
                        <div class="col-md-3">&nbsp;</div>
                        <div class="col-md-3"><a id="btnImport" Text="ตกลง" @onclick="btnImport_Click" class="btn btn-success btn-block login-button" /></div>
                        <div class="col-md-3"><button type="button" class="btn btn-default btn-block" data-dismiss="modal">ยกเลิก</button></div>
                    </div>
                </div>
            </div>
            <div id="divok" visible="false">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 rows">
                            <div class="input-group text-center">
                                <label class="col-form-label">คุณยืนยันที่จะนำข้อมูลเข้าระบบใช่หรือไม่</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border:0;">
                    <div class="row">
                        <div class="col-md-3">&nbsp;</div>
                        <div class="col-md-3"><a id="btnOK" Text="ตกลง" @onclick="btnOK_Click" class="btn btn-success btn-block login-button" /></div>
                        <div class="col-md-3"><a id="btnCancel" Text="ยกเลิก" @onclick="btnCancel_Click" class="btn btn-default btn-block" /></div>
                    </div>
                </div>
            </div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
        </div>
    </div>
</div>
@code {
    void btnImport_Click()
    {
        
    }
    void btnOK_Click()
    {
        
    }
    void btnCancel_Click()
    {
        
    }
}
